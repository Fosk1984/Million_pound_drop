<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Million Pound Drop – Spectator</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b1020'/%3E%3Ctext x='50%' y='58%' text-anchor='middle' font-family='Arial' font-size='34' fill='%235eead4'%3E£%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#0b1020;--card:#121a36;--muted:#7c88b0;--accent:#5eead4;--good:#22c55e;--bad:#ef4444;--warn:#f59e0b;--ink:#e6ecff}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:radial-gradient(1000px 600px at 20% -10%,#1a2452 0,#0b1020 60%),radial-gradient(800px 500px at 110% 10%,#1b3355 0,#0b1020 60%),var(--bg);color:var(--ink)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 80px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:800;letter-spacing:.3px}.muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:1024px){.grid.cols-2{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#16214a 0,#0f1740 100%);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .card .pad{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,button{background:#0e1637;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:12px;padding:10px 12px;font-size:15px}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,#1a2a68 0,#14204f 100%)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0d1533;border:1px solid rgba(255,255,255,.08);font-size:12px;color:var(--muted)}
    .barRow{display:grid;grid-template-columns:40px 1fr 80px;align-items:center;gap:10px}
    .bar{height:18px;background:#0b1434;border:1px solid rgba(255,255,255,.1);border-radius:10px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,rgba(94,234,212,.2),rgba(94,234,212,.8));transition:width .5s ease}
    .bar.bad>span{background:linear-gradient(90deg,rgba(239,68,68,.25),rgba(239,68,68,.9))}
    .bar.good>span{background:linear-gradient(90deg,rgba(34,197,94,.25),rgba(34,197,94,.9))}
    .tray{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .tray .cell{background:#0b1434;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;text-align:center}
    .cell.drop{animation:drop 900ms ease forwards}
    @keyframes drop{0%{transform:translateY(0);opacity:1}80%{transform:translateY(32px);opacity:.6}100%{transform:translateY(80px);opacity:0}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title" style="font-size:28px">Million Pound Drop – Spectator</div>
      <div class="muted">Read-only live board for the audience.</div>
    </div>
    <div class="row" style="max-width:700px">
      <input id="roomInput" placeholder="Room code (e.g. KEELE-2025)" />
      <button id="joinBtn">Join Room</button>
    </div>
  </header>

  <section class="card">
    <div class="pad">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="pill">Round</div>
          <div class="title" id="specRound" style="font-size:24px">—</div>
        </div>
        <div>
          <div class="pill">Phase</div>
          <div class="title" id="specPhase" style="font-size:24px">—</div>
        </div>
        <div>
          <div class="pill">Correct</div>
          <div class="title" id="specCorrect" style="font-size:24px">—</div>
        </div>
      </div>
      <div class="pill" style="margin-top:8px">Room: <b id="specRoom">(not set)</b> · Teams: <b id="specTeamCount">0</b></div>
    </div>
  </section>

  <section class="card" style="margin-top:16px">
    <div class="pad">
      <h3 style="margin:0 0 8px">Teams</h3>
      <div id="spectatorGrid" class="grid cols-2"></div>
    </div>
  </section>
</div>

<script type="module">
  // === YOUR REAL FIREBASE CONFIG (kept) ===
  const firebaseConfig = {
    apiKey: "AIzaSyANcZCVJDa_mJ3usOdNulFwgNqQC4DFy4c",
    authDomain: "million-pound-drop-a1acc.firebaseapp.com",
    databaseURL: "https://million-pound-drop-a1acc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "million-pound-drop-a1acc",
    storageBucket: "million-pound-drop-a1acc.firebasestorage.app",
    messagingSenderId: "866523395054",
    appId: "1:866523395054:web:dbbcd7c1b281cac32994ff",
    measurementId: "G-6VRXQSGG4H"
  };

  // Use the same CDN version as host.html for consistency
  import * as FBApp from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import * as FBDB  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

  const app = FBApp.initializeApp(firebaseConfig);
  let db;
  try {
    if (!firebaseConfig.databaseURL) throw new Error('Missing databaseURL');
    db = FBDB.getDatabase(app);
  } catch (e) {
    alert('Realtime Database not available: ' + e.message);
  }

  // --- Helpers / elements ---
  const el=id=>document.getElementById(id);
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,Number(n)||0));
  const moneyFromTokens=t=>`£${(t*1000).toLocaleString()}`;

  let room = new URLSearchParams(location.search).get('room') || localStorage.getItem('mpd_room') || '';
  let teamName = localStorage.getItem('mpd_team') || '';

  const roomInput=el('roomInput'), teamInput=el('teamInput'), joinBtn=el('joinBtn');
  const aInput=el('aInput'), bInput=el('bInput'), cInput=el('cInput'), dInput=el('dInput');
  const allocated=el('allocated'), remaining=el('remaining');
  const maxEvenBtn=el('maxEvenBtn'), clearBtn=el('clearBtn'), submitBtn=el('submitBtn');
  const teamMsg=el('teamMsg'), teamBalance=el('teamBalance'), timeLeft=el('timeLeft'), roundNum=el('roundNum');

  roomInput.value = room; teamInput.value = teamName;

  // DB refs (prefixed)
  const roomPath = ()=>`rooms/${room}`;
  const roundRef = ()=> FBDB.ref(db, roomPath()+`/round`);
  const teamsRef = ()=> FBDB.ref(db, roomPath()+`/teams`);
  const teamRef  = ()=> FBDB.ref(db, roomPath()+`/teams/${encodeURIComponent(teamName)}`);

  // UI helpers
  function refreshAllocUI(){
    const a=clamp(aInput.value,0,1000),
          b=clamp(bInput.value,0,1000),
          c=clamp(cInput.value,0,1000),
          d=clamp(dInput.value,0,1000);
    const sum=a+b+c+d;
    allocated.textContent=sum;
    remaining.textContent=Math.max(0,1000-sum);
  }
  [aInput,bInput,cInput,dInput].forEach(i=> i.addEventListener('input',refreshAllocUI));
  maxEvenBtn.addEventListener('click',()=>{
    const q=Math.floor(1000/4), r=1000-q*4;
    aInput.value=q+(r>0?1:0); bInput.value=q+(r>1?1:0); cInput.value=q+(r>2?1:0); dInput.value=q;
    refreshAllocUI();
  });
  clearBtn.addEventListener('click',()=>{ aInput.value=bInput.value=cInput.value=dInput.value=0; refreshAllocUI(); });

  // Join / create team in room
  async function joinRoom(){
    room = roomInput.value.trim();
    teamName = teamInput.value.trim();
    if(!room){ alert('Enter a room code'); return; }
    if(!teamName){ alert('Enter a team name'); return; }

    localStorage.setItem('mpd_room', room);
    localStorage.setItem('mpd_team', teamName);

    await FBDB.update(FBDB.ref(db, roomPath()+`/settings`), { createdAt: Date.now() });
    await FBDB.update(teamRef(), { name: teamName, balanceTokens: 1000, lastSeen: Date.now() });
    subscribe();
  }
  joinBtn.addEventListener('click', joinRoom);

  // Submit allocation
  async function submitAllocation(){
    if(!room||!teamName){ alert('Join a room and set a team name first.'); return; }
    const rSnap = await FBDB.get(roundRef());
    const v = rSnap.val() || {};
    const r = v.number || 1;
    if(v.phase!=='active'){ teamMsg.textContent='You can only submit while the round is active.'; return; }
    const a=clamp(aInput.value,0,1000),
          b=clamp(bInput.value,0,1000),
          c=clamp(cInput.value,0,1000),
          d=clamp(dInput.value,0,1000);
    const sum=a+b+c+d;
    if(sum>1000){ alert('More than 1000 tokens.'); return; }

    await FBDB.update(FBDB.ref(db, `${roomPath()}/teams/${encodeURIComponent(teamName)}/allocations/${r}`),
      {A:a,B:b,C:c,D:d,locked:false,at:Date.now()});
    teamMsg.textContent='Allocation saved.';
  }
  submitBtn.addEventListener('click', submitAllocation);

  // Live bindings
  function subscribe(){
    if(!room||!db) return;

    FBDB.onValue(roundRef(), snap=>{
      const v=snap.val()||{number:1,phase:'idle',duration:45,startAt:0,correct:''};
      roundNum.textContent=v.number||1;

      if(v.phase==='active'&&v.duration>0&&v.startAt){
        const tick=()=>{
          const now=Date.now();
          const remainingMs=Math.max(0,(v.startAt+v.duration*1000)-now);
          const sec=Math.ceil(remainingMs/1000);
          timeLeft.textContent=`${sec}s`;
          if(sec>0) requestAnimationFrame(tick); else timeLeft.textContent='0s';
        };
        tick();
      } else {
        timeLeft.textContent='—';
      }

      const phases={idle:'Waiting for the host to start…',active:'Round active – allocate & lock in!',locked:'Locked – awaiting reveal…',revealed:v.correct?`Revealed: ${v.correct}`:'Revealed'};
      teamMsg.textContent=phases[v.phase]||'—';

      const disabled = v.phase!=='active';
      [aInput,bInput,cInput,dInput,submitBtn,maxEvenBtn,clearBtn].forEach(i=> i.disabled=disabled);
    });

    FBDB.onValue(teamsRef(), snap=>{
      const teams=snap.val()||{};
      const key=encodeURIComponent(teamName);
      const me = teams[key] || Object.values(teams).find(t=>t.name===teamName) || {balanceTokens:1000};
      teamBalance.textContent = moneyFromTokens(me.balanceTokens!=null?me.balanceTokens:1000);
    });
  }

  if(room && teamName){ subscribe(); }
  refreshAllocUI();
</script>
</body>
</html>

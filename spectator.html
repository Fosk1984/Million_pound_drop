<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Million Pound Drop â€“ Spectator (Showtime)</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b1020'/%3E%3Ctext x='50%' y='58%' text-anchor='middle' font-family='Arial' font-size='34' fill='%235eead4'%3EÂ£%3C/text%3E%3C/svg%3E">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800;900&family=Chivo+Mono:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070b1a; --ink:#e9efff; --muted:#8ea0d6;
      --card:#0f1838; --card2:#122255;
      --accent:#5eead4; --accent-2:#8b5cf6;
      --good:#22c55e; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Plus Jakarta Sans",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;color:var(--ink);
      background:
      radial-gradient(1200px 700px at 10% -10%,#1b2a62 0,#0b1020 55%),
      radial-gradient(900px 600px at 120% 0%,#1d3566 0,#0b1020 55%),
      radial-gradient(1000px 800px at -20% 120%,#0d1a3f 0,#0b1020 70%),
      var(--bg);
      overflow-x:hidden}

    .wrap{max-width:1400px;margin:0 auto;padding:28px 16px 120px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-weight:900;font-size:34px;letter-spacing:.4px;text-shadow:0 1px 0 rgba(255,255,255,.06), 0 10px 28px rgba(139,92,246,.22)}
    .title b{background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .muted{color:var(--muted)}

    .grid{display:grid;gap:18px}
    .cols-2{grid-template-columns:420px 1fr}
    @media(max-width:1180px){.cols-2{grid-template-columns:1fr}}

    .card{position:relative;background:linear-gradient(180deg,rgba(22,33,74,.75),rgba(15,23,64,.9));backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,.12);border-radius:22px;box-shadow:0 22px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);overflow:hidden}
    .pad{padding:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,button{background:#0e1637;border:1px solid rgba(255,255,255,.14);color:var(--ink);border-radius:14px;padding:10px 12px;font-size:15px}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,#1a2a68 0,#14204f 100%);box-shadow:0 8px 22px rgba(0,0,0,.35)}

    /* LEFT COLUMN â€” Answer + Countdown + Leaderboard */
    .scoreHead{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center}
    .revealBadge{display:grid;place-items:center;width:140px;height:140px;margin:0 auto;border-radius:999px;background:radial-gradient(closest-side,rgba(255,255,255,.08),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);box-shadow:inset 0 0 18px rgba(255,255,255,.12), 0 12px 30px rgba(0,0,0,.4);position:relative}
    .revealBadge span{font-family:"Chivo Mono",monospace;font-weight:900;font-size:54px;letter-spacing:1px}
    .revealBadge.revealed{background:radial-gradient(closest-side, rgba(94,234,212,.15), rgba(139,92,246,.12));box-shadow:0 0 80px rgba(94,234,212,.25)}
    .revealLabel{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);font-weight:800;opacity:.95}
    .revealBadge.revealed .revealLabel{color:#eafffa;text-shadow:0 0 18px rgba(94,234,212,.35)}

    .countWrap{display:grid;place-items:center}
    .timerRing{ --pct:0; width:140px; height:140px; border-radius:999px; display:grid; place-items:center; position:relative; background: conic-gradient(var(--accent) calc(var(--pct)*1%), rgba(255,255,255,.08) 0); box-shadow:0 0 28px rgba(94,234,212,.2) inset, 0 0 10px rgba(94,234,212,.25) }
    .timerRing::before{ content:""; position:absolute; inset:10px; border-radius:inherit; background:#0b1020; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06) }
    .timerRing span{ position:relative; font-weight:900; font-family:"Chivo Mono", monospace; font-size:34px }
    .timerLabel{margin-top:8px; color:var(--muted); font-weight:800; letter-spacing:.12em; text-transform:uppercase}

    .leader{margin-top:10px}
    .leaderRow{display:grid;grid-template-columns:56px 1fr 160px;gap:10px;align-items:center;padding:10px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .medal{width:36px;height:36px;border-radius:999px;display:grid;place-items:center;font-weight:900}
    .medal.g{background:linear-gradient(135deg,#ffd166,#f59e0b)}
    .medal.s{background:linear-gradient(135deg,#cbd5e1,#94a3b8)}
    .medal.b{background:linear-gradient(135deg,#fca5a5,#fb7185)}
    .leaderRow .name{font-size:18px;font-weight:900}
    .leaderRow .bal{font-family:"Chivo Mono",monospace;font-size:20px;font-weight:900;text-align:right}

    /* RIGHT COLUMN â€” TEAMS GRID (unchanged) */
    .teamsGrid{display:grid;gap:16px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:1180px){.teamsGrid{grid-template-columns:1fr}}
    .teamCard{position:relative;background:linear-gradient(180deg,rgba(18,28,70,.8),rgba(10,18,52,.9));border:1px solid rgba(255,255,255,.1);border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.45);overflow:hidden}
    .teamCard .pad{padding:14px 16px}
    .barRow{display:grid;grid-template-columns:40px 1fr 120px;align-items:center;gap:10px}
    .bar{height:18px;background:#0b1434;border:1px solid rgba(255,255,255,.1);border-radius:10px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,rgba(94,234,212,.2),rgba(94,234,212,.9));transition:width .6s ease}
    .bar.bad>span{background:linear-gradient(90deg,rgba(239,68,68,.25),rgba(239,68,68,.9))}
    .bar.good>span{background:linear-gradient(90deg,rgba(34,197,94,.25),rgba(34,197,94,.9))}
    .tray{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .tray .cell{background:#0b1434;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;text-align:center}

    /* Emphasised team header */
    .teamName{margin:0;font-size:28px;font-weight:900;letter-spacing:.4px;text-shadow:0 2px 0 rgba(255,255,255,.06),0 10px 28px rgba(139,92,246,.22)}
    .balanceChip{font-family:"Chivo Mono",monospace;font-size:22px;font-weight:900;padding:8px 14px;border-radius:14px;background:linear-gradient(135deg,var(--accent) 0%,#22d3ee 45%,var(--accent-2) 100%);color:#041316;border:none;box-shadow:0 8px 26px rgba(94,234,212,.25), inset 0 1px 0 rgba(255,255,255,.3);display:inline-flex;align-items:center;gap:8px}
    .balanceChip small{opacity:.85;font-weight:800;letter-spacing:.3px}

    /* DEAD overlay */
    .teamCard.dead .pad{filter:grayscale(1) brightness(.65); opacity:.65}
    .deadMark{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:170px;line-height:1;color:rgba(239,68,68,.55);text-shadow:0 8px 24px rgba(239,68,68,.35);pointer-events:none}
    .deadLabel{position:absolute;top:8px;right:8px;background:rgba(239,68,68,.95);color:#fff;border-radius:999px;padding:6px 10px;font-weight:800;letter-spacing:.5px;box-shadow:0 6px 18px rgba(239,68,68,.35)}

    /* Confetti */
    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .confetti span{position:absolute;width:10px;height:16px;background:var(--c);opacity:.95;transform:translateY(-20vh) rotate(0deg);animation:fall 1600ms ease-out forwards}
    @keyframes fall{to{transform:translateY(110vh) rotate(360deg); opacity:1}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">ðŸ’· <b>Million</b> Pound Drop â€” Spectator</div>
      <div class="muted">Live board for the audience. (Readâ€‘only)</div>
    </div>
    <div class="row" style="max-width:700px">
      <input id="roomInput" placeholder="Room code (e.g. KEELE-2025)" />
      <button id="joinBtn">Join Room</button>
    </div>
  </header>

  <section class="grid cols-2">
    <!-- LEFT: Answer + Countdown + Leaderboard -->
    <div class="card scoreCard">
      <div class="pad">
        <div class="scoreHead">
          <div class="revealBadge" id="revealBadge"><span id="specCorrect">?</span><div class="revealLabel">Answer</div></div>
          <div class="countWrap">
            <div class="timerRing" id="timerRing"><span id="timerText">â€”</span></div>
            <div class="timerLabel">Countdown</div>
          </div>
        </div>
        <h3 class="leader" style="margin:16px 0 8px">Leaderboard</h3>
        <div id="leaderboard"></div>
      </div>
    </div>

    <!-- RIGHT: TEAMS GRID -->
    <div class="card">
      <div class="pad">
        <h3 style="margin:0 0 8px">Teams</h3>
        <div id="spectatorGrid" class="teamsGrid"></div>
      </div>
    </div>
  </section>
</div>
<div id="confetti" class="confetti"></div>

<script type="module">
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyANcZCVJDa_mJ3usOdNulFwgNqQC4DFy4c",
    authDomain: "million-pound-drop-a1acc.firebaseapp.com",
    databaseURL: "https://million-pound-drop-a1acc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "million-pound-drop-a1acc",
    storageBucket: "million-pound-drop-a1acc.firebasestorage.app",
    messagingSenderId: "866523395054",
    appId: "1:866523395054:web:dbbcd7c1b281cac32994ff",
    measurementId: "G-6VRXQSGG4H"
  };

  import * as FBApp from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import * as FBDB  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

  const app = FBApp.initializeApp(firebaseConfig);
  const db  = FBDB.getDatabase(app);

  const $ = id=>document.getElementById(id);
  const money = n => 'Â£' + Number(n||0).toLocaleString();

  let room = new URLSearchParams(location.search).get('room') || localStorage.getItem('mpd_room') || '';
  const roomInput=$('roomInput'); const joinBtn=$('joinBtn');
  const specCorrect=$('specCorrect'); const revealBadge=$('revealBadge');
  const leaderboardEl=$('leaderboard'); const grid=$('spectatorGrid');
  const confetti=$('confetti');

  const timerRing=$('timerRing'); const timerText=$('timerText');

  roomInput.value = room;

  const roomPath = ()=>`rooms/${room}`;
  const settingsRef=()=> FBDB.ref(db, roomPath()+`/settings`);
  const teamsRef  =()=> FBDB.ref(db, roomPath()+`/teams`);

  // Confetti on reveal
  let lastPhase = '';
  function burst(){
    confetti.innerHTML = '';
    const colors = ['#5eead4','#8b5cf6','#22c55e','#fde047','#fb7185'];
    for(let i=0;i<80;i++){
      const s = document.createElement('span');
      s.style.left = Math.random()*100 + 'vw';
      s.style.top = (-10 - Math.random()*30) + 'vh';
      s.style.setProperty('--c', colors[Math.floor(Math.random()*colors.length)]);
      s.style.transform = `translateY(${-20 - Math.random()*40}vh) rotate(${Math.random()*360}deg)`;
      s.style.animationDelay = (Math.random()*300)+'ms';
      confetti.appendChild(s);
    }
    setTimeout(()=> confetti.innerHTML='', 1800);
  }

  // Countdown ring
  let rafId=null;
  function setRing(sec, duration, active){
    const pct = !active || !duration ? 0 : Math.max(0, Math.min(1, sec / duration)) * 100;
    timerRing.style.setProperty('--pct', pct);
    timerText.textContent = active ? `${Math.max(0,Math.ceil(sec))}s` : 'â€”';
  }
  function bindCountdown(v){
    if(rafId) cancelAnimationFrame(rafId);
    const t=v&&v.timer; const active=v&&v.phase==='active'&&t&&t.startAt&&t.duration>0;
    if(!active){ setRing(0,0,false); return; }
    const deadline=t.startAt+t.duration*1000;
    const tick=()=>{
      const sec=Math.max(0,(deadline-Date.now())/1000);
      setRing(sec, t.duration, v.phase==='active');
      if(sec>0 && v.phase==='active') rafId=requestAnimationFrame(tick); else setRing(0,0,false);
    };
    tick();
  }

  function renderLeaderboard(teams){
    const arr = Object.keys(teams||{}).map(k=>{
      const t=teams[k]||{}; return {name:t.name||decodeURIComponent(k)||k, bal:Number(t.balance??1000000), dead: !!t.dead};
    }).sort((a,b)=> b.bal - a.bal).slice(0,8);

    leaderboardEl.innerHTML = arr.map((t,i)=>{
      const m = i===0?'g':i===1?'s':'b';
      const medal = `<div class="medal ${i<3?m:''}">${i+1}</div>`;
      const name = `<div class="name">${t.name}${t.dead?' <span class="pill" style="margin-left:6px">ELIM</span>':''}</div>`;
      const bal  = `<div class="bal">${money(t.bal)}</div>`;
      return `<div class="leaderRow">${medal}${name}${bal}</div>`;
    }).join('');
  }

  function teamCardHtml(key, t, state){
    const name = t.name || decodeURIComponent(key) || key;
    const alloc = t.alloc || {A:0,B:0,C:0,D:0};
    const bal   = Number(t.balance != null ? t.balance : 1000000);
    const isDead = t.dead === true || bal <= 0;
    const total = (Number(alloc.A)||0)+(Number(alloc.B)||0)+(Number(alloc.C)||0)+(Number(alloc.D)||0);
    const pct = x => total>0 ? Math.round((Number(x)/Math.max(total,1))*100) : 0;
    const correct = state.correct || '';
    const revealed = state.phase==='revealed' && !!correct;
    const barCls = opt => revealed ? (opt===correct? 'bar good':'bar bad') : 'bar';

    return `
      <div class="teamCard ${isDead?'dead':''}">
        <div class="pad">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h4 class="teamName">${name}</h4>
            <div class="balanceChip"><small>Balance</small> Â£${bal.toLocaleString()} ${isDead? 'Â· DEAD':''}</div>
          </div>
          <div class="barRow"><div>A</div><div class="${barCls('A')}"><span style="width:${pct(alloc.A)}%"></span></div><div style="text-align:right">Â£${(alloc.A||0).toLocaleString()}</div></div>
          <div class="barRow"><div>B</div><div class="${barCls('B')}"><span style="width:${pct(alloc.B)}%"></span></div><div style="text-align:right">Â£${(alloc.B||0).toLocaleString()}</div></div>
          <div class="barRow"><div>C</div><div class="${barCls('C')}"><span style="width:${pct(alloc.C)}%"></span></div><div style="text-align:right">Â£${(alloc.C||0).toLocaleString()}</div></div>
          <div class="barRow"><div>D</div><div class="${barCls('D')}"><span style="width:${pct(alloc.D)}%"></span></div><div style="text-align:right">Â£${(alloc.D||0).toLocaleString()}</div></div>
          <div class="tray" style="margin-top:8px">
            <div class="cell">A: Â£${(alloc.A||0).toLocaleString()}</div>
            <div class="cell">B: Â£${(alloc.B||0).toLocaleString()}</div>
            <div class="cell">C: Â£${(alloc.C||0).toLocaleString()}</div>
            <div class="cell">D: Â£${(alloc.D||0).toLocaleString()}</div>
          </div>
        </div>
        ${isDead? '<div class="deadMark" aria-hidden="true">âœ•</div><div class="deadLabel">ELIMINATED</div>':''}
      </div>`;
  }

  function renderTeams(teams, state){
    // Sort by balance desc, then name
    const keys = Object.keys(teams||{}).sort((a,b)=>{
      const ta=teams[a]||{}, tb=teams[b]||{};
      const ba=Number(ta.balance??0), bb=Number(tb.balance??0);
      if(bb!==ba) return bb-ba; return (ta.name||a).localeCompare(tb.name||b);
    });
    grid.innerHTML = keys.map(k=> teamCardHtml(k, teams[k]||{}, state)).join('');
  }

  function subscribe(){
    if(!room) return;
    FBDB.onValue(settingsRef(), s=>{
      const v = s.val() || {phase:'between',correct:''};
      specCorrect.textContent = v.correct || 'â€”';
      revealBadge.classList.toggle('revealed', v.phase==='revealed');
      bindCountdown(v);
      if(lastPhase !== 'revealed' && v.phase === 'revealed'){ burst(); }
      lastPhase = v.phase || '';
      FBDB.get(teamsRef()).then(ts=>{
        const teams = ts.val()||{};
        renderLeaderboard(teams); renderTeams(teams, v);
      });
    });
    FBDB.onValue(teamsRef(), t=>{
      const teams = t.val()||{};
      FBDB.get(settingsRef()).then(s=>{ const v=s.val()||{}; renderLeaderboard(teams); renderTeams(teams, v); });
    });
  }

  function joinRoom(){
    room = roomInput.value.trim(); if(!room){ alert('Enter a room code'); return; }
    localStorage.setItem('mpd_room', room); subscribe();
  }
  joinBtn.addEventListener('click', joinRoom);

  if(room){ subscribe(); }
</script>
</body>
</html>

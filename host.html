<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Million Pound Drop – Host</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b1020'/%3E%3Ctext x='50%' y='58%' text-anchor='middle' font-family='Arial' font-size='34' fill='%235eead4'%3E£%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--card:#121a36;--muted:#8ea0d6;--accent:#5eead4;--good:#22c55e;--bad:#ef4444;--ink:#e6ecff}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:"Plus Jakarta Sans",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:radial-gradient(1000px 600px at 20% -10%,#1a2452 0,#0b1020 60%),radial-gradient(800px 500px at 110% 10%,#1b3355 0,#0b1020 60%),var(--bg);color:var(--ink)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 80px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:900;letter-spacing:.3px;font-size:28px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:1024px){.grid.cols-2{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#16214a 0,#0f1740 100%);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .card .pad{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button{background:#0e1637;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:12px;padding:10px 12px;font-size:15px}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,#1a2a68 0,#14204f 100%)}
    button.primary{background:linear-gradient(180deg,#00b3a4 0,#0aa596 100%);border:none;color:#001b18;font-weight:800}
    button.danger{background:linear-gradient(180deg,#ff6672 0,#ef4444 100%);border:none}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0d1533;border:1px solid rgba(255,255,255,.08);font-size:12px;color:var(--muted)}

    .barRow{display:grid;grid-template-columns:40px 1fr 110px;align-items:center;gap:10px}
    .bar{height:18px;background:#0b1434;border:1px solid rgba(255,255,255,.1);border-radius:10px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,rgba(94,234,212,.2),rgba(94,234,212,.8));transition:width .5s ease}
    .bar.bad>span{background:linear-gradient(90deg,rgba(239,68,68,.25),rgba(239,68,68,.9))}
    .bar.good>span{background:linear-gradient(90deg,rgba(34,197,94,.25),rgba(34,197,94,.9))}
    .tray{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .tray .cell{background:#0b1434;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;text-align:center}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">Million Pound Drop – Host</div>
      <div class="muted">Project this view. Create a room and control rounds.</div>
    </div>
    <div class="row" style="max-width:720px">
      <input id="roomInput" placeholder="Room code (e.g. KEELE-2025)" />
      <button id="joinBtn" class="primary">Create / Join Room</button>
    </div>
  </header>

  <section class="card">
    <div class="pad">
      <div class="row" style="align-items:flex-end">
        <div>
          <label>Round</label>
          <div class="row" style="gap:8px">
            <button id="prevRound">◀</button>
            <input id="roundInput" type="number" min="1" value="1" />
            <button id="nextRound">▶</button>
          </div>
        </div>
        <div>
          <label>Timer (sec)</label>
          <input id="timerInput" type="number" min="0" value="45" />
        </div>
        <div>
          <label>Controls</label>
          <div class="row" style="gap:8px">
            <button id="startRound" class="primary">Start</button>
            <button id="revealBtn" class="danger">Reveal</button>
            <select id="revealSelect">
              <option value="">Correct…</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
            <button id="advanceBtn">Next round</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:16px">
    <div class="pad">
      <h3 style="margin:0 0 8px">Teams</h3>
      <div id="teamsGrid" class="grid cols-2"></div>
    </div>
  </section>
</div>

<script type="module">
  // === FIREBASE CONFIG — YOURS ===
  const firebaseConfig = {
    apiKey: "AIzaSyANcZCVJDa_mJ3usOdNulFwgNqQC4DFy4c",
    authDomain: "million-pound-drop-a1acc.firebaseapp.com",
    databaseURL: "https://million-pound-drop-a1acc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "million-pound-drop-a1acc",
    storageBucket: "million-pound-drop-a1acc.firebasestorage.app",
    messagingSenderId: "866523395054",
    appId: "1:866523395054:web:dbbcd7c1b281cac32994ff",
    measurementId: "G-6VRXQSGG4H"
  };

  import * as FBApp from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import * as FBDB  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

  const app = FBApp.initializeApp(firebaseConfig);
  const db  = FBDB.getDatabase(app);

  // Helpers
  const $ = id=>document.getElementById(id);
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,Number(n)||0));
  const money=n=>'£'+Number(n||0).toLocaleString();

  // UI refs
  const roomInput=$('roomInput'); const joinBtn=$('joinBtn');
  const prevRound=$('prevRound'); const nextRound=$('nextRound'); const roundInput=$('roundInput');
  const timerInput=$('timerInput'); const startRound=$('startRound');
  const revealSelect=$('revealSelect'); const revealBtn=$('revealBtn');
  const advanceBtn=$('advanceBtn');
  const teamsGrid=$('teamsGrid');

  // State
  let room = new URLSearchParams(location.search).get('room') || localStorage.getItem('mpd_room') || '';
  roomInput.value = room;

  const roomPath = ()=>`rooms/${room}`;
  const settingsRef = ()=> FBDB.ref(db, roomPath()+`/settings`);
  const teamsRef    = ()=> FBDB.ref(db, roomPath()+`/teams`);

  // Join / create room
  async function joinRoom(){
    room = roomInput.value.trim();
    if(!room){ alert('Enter a room code'); return; }
    localStorage.setItem('mpd_room', room);
    await FBDB.update(settingsRef(), { createdAt: Date.now() });
    subscribe();
  }
  joinBtn.addEventListener('click', joinRoom);

  // \n  // NEW FLOW per request:\n  // - "Next round" clears allocations (keeps teams locked, phase='between').\n  // - "Start" switches to phase='active', UNLOCKS alive teams and STARTS the timer.\n  //

  // Start round: start timer + unlock alive teams (do NOT clear allocations here)
  async function hostStart(){
    if(!room){ alert('Set a room code first.'); return; }
    const number = clamp(roundInput.value,1,999);
    const duration = clamp(timerInput.value,0,999);
    // Phase -> active with fresh timer
    await FBDB.update(settingsRef(), { number, phase:'active', correct:'', timer:{ startAt: Date.now(), duration } });
    // Unlock alive teams only
    const s = await FBDB.get(teamsRef());
    if(s.exists()){
      const teams = s.val(); const updates={};
      Object.keys(teams).forEach(k=>{
        const t=teams[k]||{}; if(t.dead===true || Number(t.balance||0)<=0) return;
        updates[`${roomPath()}/teams/${k}/locked`] = false;
      });
      if(Object.keys(updates).length) await FBDB.update(FBDB.ref(db), updates);
    }
  }

  // Next round: advance number, set between phase, CLEAR allocations, keep locked
  async function hostAdvance(){
    if(!room){ alert('Set a room code first.'); return; }
    const next = clamp(roundInput.value,1,999) + 1; roundInput.value = next;
    const duration = clamp(timerInput.value,0,999);
    // phase between + reset timer placeholder
    await FBDB.update(settingsRef(), { number: next, phase:'between', correct:'', timer:{ startAt:0, duration } });
    // Clear allocations for all teams (alive or dead for consistency); keep locked as-is
    const s = await FBDB.get(teamsRef());
    if(s.exists()){
      const teams = s.val(); const updates={};
      Object.keys(teams).forEach(k=>{
        updates[`${roomPath()}/teams/${k}/alloc`] = {A:0,B:0,C:0,D:0};
      });
      if(Object.keys(updates).length) await FBDB.update(FBDB.ref(db), updates);
    }
  }

  // Auto-lock when all locked or timer ends
  async function maybeLock(){
    const stSnap = await FBDB.get(settingsRef()); const st = stSnap.val()||{};
    if(st.phase!=='active') return;
    const t = st.timer || {}; const deadline = (t.startAt||0) + (t.duration||0)*1000;
    const now = Date.now();
    const teamsSnap = await FBDB.get(teamsRef()); const teams = teamsSnap.val()||{};
    const aliveKeys = Object.keys(teams).filter(k=> !(teams[k]?.dead===true) && Number(teams[k]?.balance||0)>0 );
    const allLocked = aliveKeys.length>0 && aliveKeys.every(k=> teams[k]?.locked===true);
    if(allLocked || (t.duration>0 && now>=deadline)){
      await FBDB.update(settingsRef(), { phase:'locked' });
    }
  }

  // Reveal answer and settle balances
  async function hostReveal(){
    if(!room) return; const correct = revealSelect.value; if(!correct){ alert('Pick the correct option.'); return; }
    await FBDB.update(settingsRef(), { phase:'revealed', correct });
    const s = await FBDB.get(teamsRef());
    if(s.exists()){
      const teams = s.val(); const updates={};
      Object.keys(teams).forEach(k=>{
        const t=teams[k]||{}; if(t.dead===true) return;
        const bal = Number(t.balance||0);
        const a = t.alloc||{A:0,B:0,C:0,D:0};
        const lost = ['A','B','C','D'].filter(x=>x!==correct).reduce((sum,opt)=> sum + (Number(a[opt])||0), 0);
        const next = Math.max(0, bal - lost);
        updates[`${roomPath()}/teams/${k}/balance`] = next;
        updates[`${roomPath()}/teams/${k}/locked`]  = true; // keep locked until Start
        if(next===0) updates[`${roomPath()}/teams/${k}/dead`]=true;
      });
      if(Object.keys(updates).length) await FBDB.update(FBDB.ref(db), updates);
    }
  }

  startRound.addEventListener('click', hostStart);
  revealBtn.addEventListener('click', hostReveal);
  advanceBtn.addEventListener('click', hostAdvance);
  prevRound.addEventListener('click', ()=>{ roundInput.value = clamp(Number(roundInput.value)-1,1,999); });
  nextRound.addEventListener('click', ()=>{ roundInput.value = clamp(Number(roundInput.value)+1,1,999); });

  function teamBars(label, val, pct, cls){
    return `<div class="barRow"><div>${label}</div><div class="${cls}"><span style="width:${pct}%"></span></div><div style="text-align:right">£${Number(val||0).toLocaleString()}</div></div>`;
  }
  function renderTeamsHtml(teams, state){
    const correct = state.correct || '';
    const revealed = state.phase==='revealed' && !!correct;
    const names = Object.keys(teams||{}).sort();
    return names.map(key=>{
      const t = teams[key]||{}; const name=t.name||decodeURIComponent(key)||key; const a=t.alloc||{A:0,B:0,C:0,D:0};
      const total = (Number(a.A)||0)+(Number(a.B)||0)+(Number(a.C)||0)+(Number(a.D)||0);
      const pct = x => total>0 ? Math.round((Number(x)/Math.max(total,1))*100) : 0;
      const barCls = opt => revealed ? (opt===correct?'bar good':'bar bad') : 'bar';
      const bal = Number(t.balance!=null?t.balance:1000000);
      return `
        <div class="card"><div class="pad">
          <div class="row" style="justify-content:space-between;align-items:baseline"><h4>${name}</h4><div class="pill">Balance: ${money(bal)} ${t.dead? '· DEAD':''}</div></div>
          ${teamBars('A', a.A, pct(a.A), barCls('A'))}
          ${teamBars('B', a.B, pct(a.B), barCls('B'))}
          ${teamBars('C', a.C, pct(a.C), barCls('C'))}
          ${teamBars('D', a.D, pct(a.D), barCls('D'))}
          <div class="tray" style="margin-top:8px">
            <div class="cell">A: £${Number(a.A||0).toLocaleString()}</div>
            <div class="cell">B: £${Number(a.B||0).toLocaleString()}</div>
            <div class="cell">C: £${Number(a.C||0).toLocaleString()}</div>
            <div class="cell">D: £${Number(a.D||0).toLocaleString()}</div>
          </div>
        </div></div>`;
    }).join('');
  }

  function subscribe(){
    if(!room || !db) return;
    // Any settings change -> redraw, and check lock condition
    FBDB.onValue(settingsRef(), snap=>{
      const v = snap.val() || { number:1, phase:'between', correct:'', timer:{startAt:0,duration:45} };
      roundInput.value = v.number || 1;
      timerInput.value = (v.timer && v.timer.duration) || 45;
      FBDB.get(teamsRef()).then(s=>{ teamsGrid.innerHTML = renderTeamsHtml(s.val()||{}, v); });
      maybeLock();
    });
    // Team changes -> redraw, and check lock condition
    FBDB.onValue(teamsRef(), snap=>{
      const teams = snap.val() || {};
      FBDB.get(settingsRef()).then(rSnap=>{ const st=rSnap.val()||{}; teamsGrid.innerHTML = renderTeamsHtml(teams, st); maybeLock(); });
    });
  }

  if(room){ subscribe(); }
</script>
</body>
</html>
